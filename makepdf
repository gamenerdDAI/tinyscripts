#!/bin/bash

# Option parsing template by http://qiita.com/rita_cano_bika/items/9fcb2a61c6f360632541
PROGNAME=$(basename $0)
for OPT in "$@"
do
  case "$OPT" in
    '-o'|'--open' )
      open=1
      shift
      ;;
    '-d'|'--directory'|'-D')
      if [[ "$1" = "-D" ]]; then
        pdfsamedir=1
      fi
      chdst=1
      if [[ ! -z "$2" ]] && [[ ! "$2" =~ ^-+ ]]; then
        dstdir="$2"
        shift
      fi
      shift
      ;;
    '--'|'-' )
      shift 1
      param+=( "$@" )
      break
      ;;
    -*)
      echo "$PROGNAME: 「$(echo $1 | sed 's/^-*//')」オプションは存在しません．" 1>&2
      exit 1
      ;;
    *)
      if [[ ! -z "$1" ]] && [[ ! "$1" =~ ^-+ ]]; then
        param+=( "$1" )
        shift 1
      fi
      ;;
  esac
done

if [ -z $param ]; then
  echo "$PROGNAME: 引数がありません．"
  exit 1
fi
target=$(basename $param)
noext=${target%.tex}

if [[ "$chdst" = "1" ]] && [[ -z "$dstdir" ]]; then
  dstdir=$(dirname $target)/$noext
elif [[ ! "$chdst" = "1" ]]; then
  dstdir=.
fi

if [[ ! -d "$dstdir" ]]; then
  mkdir -p $dstdir
fi

if [[ "$pdfsamedir" = "1" ]]; then
  pdfdir=$(dirname $target)
else
  pdfdir=$dstdir
fi
pdffn=$pdfdir/$noext.pdf

for f in 1st 2nd 3rd final; do
  echo "---------- $f try ----------"
  uplatex -interaction=nonstopmode --output-directory="$dstdir" $target > /dev/null || exit 1
  grep 'Rerun' "$dstdir/$noext.log" || break
done

echo "$dstdir/$noext.dvi"
dvipdfmx -o $pdffn "$dstdir/$noext.dvi"

if [ "$open" = 1 ] ; then
    open $pdffn
fi
